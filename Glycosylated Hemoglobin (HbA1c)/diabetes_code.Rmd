---
title: "Diabetes results"
author: "Gallardo-GÃ³mez, D."
date: '2022-09-05'
output: html_document
---

### Load libraries

```{r, message=FALSE, error=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
library(tidybayes)
library(brms)
library(readxl)
library(ggthemes)
library(ggsci)
library(cowplot)
library(MBNMAdose)
library(kableExtra)
library(ggdist)
library(patchwork)
library(modelr)
library(metR)
```


### Load our dataset

```{r, echo=FALSE}
data <- read_xlsx(path = "", # write the path where the dataset is stored
                  col_names = TRUE, na = c("NA", ""))
```

```{r, echo=FALSE}
# Data wrangling
data <- data %>% mutate(agent = ifelse(agent == "multicomponent", "Multicomponent", agent),
                agent = ifelse(agent == "resistance", "Resistance", agent))

# Fill in baseline NA values
data[c(273, 274),]$baseline_glyc <- data[c(273, 274),]$premean %>% as.numeric()

# Create the ADA categorization and adding it to our dataset
data <- data%>%
  mutate(baseline = case_when(
    baseline_glyc < 6.5 ~ "Prediabetes",
    baseline_glyc %in% seq(6.5, 7, 0.01) ~ "Controlled T2DM",
    baseline_glyc %in% seq(7.01, 8, 0.01) ~ "Uncontrolled T2DM",
    baseline_glyc > 8 ~ "Severe uncontrolled T2DM"
  )) %>% # so strange that 30 values were NAs; after revise them, all belonged to the controlled category 
  mutate(baseline = ifelse(is.na(baseline) == TRUE, "Uncontrolled T2DM", baseline)) %>%
  mutate(baseline = factor(baseline, levels = c("Prediabetes",
                                                "Controlled T2DM",
                                                "Uncontrolled T2DM",
                                                "Severe uncontrolled T2DM"))) 


# setting theme
theme_set(theme_tidybayes() + panel_border())
```


## Studies characteristics

Our systematic review included `r data %>% filter(!duplicated(studyID)) %>% nrow()` studies (`r data %>% nrow()` effect sizes; `r data %>% filter(!duplicated(studyID)) %>% .$N %>% sum(na.rm = TRUE)` participants). The median age of our sample was `r median(data$age, na.rm = TRUE)` years old (range = `r range(data$age, na.rm = TRUE)[1]` - `r range(data$age, na.rm = TRUE)[2]`). The mean duration of diabetes since diagnosis was `r round(mean(data$illness_duration, na.rm = TRUE), 2)` years. A total of `r data %>% filter(!duplicated(studyID)) %>% .$sex_males %>% sum(na.rm = TRUE)` (`r round(data %>% filter(!duplicated(studyID)) %>% .$sex_males %>% sum(na.rm = TRUE)*100/ data %>% filter(!duplicated(studyID)) %>% .$N %>% sum(na.rm = TRUE), 2)`%) participants were males. The median glycemia baseline level was `r median(data$baseline_glyc, na.rm = TRUE)` (range = `r range(data$baseline_glyc, na.rm = TRUE)[1]` - `r range(data$baseline_glyc, na.rm = TRUE)[2]`). The median body mass index (BMI) was `r round(median(data$BMI, na.rm = TRUE), 2)` (range = `r range(data$BMI, na.rm = TRUE)[1]` - `r range(data$BMI, na.rm = TRUE)[2]`).

Aerobic-based interventions (`r data %>% filter(trt_new == "Cycling") %>% nrow()` data points) had a median time per session of `r data %>% filter(trt_new == "Cycling") %>% .$time_session %>% median(na.rm = TRUE)` min (range = `r data %>% filter(trt_new == "Cycling") %>% .$time_session %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(trt_new == "Cycling") %>% .$time_session %>% range(na.rm = TRUE) %>% .[2]`), a median frequency of `r data %>% filter(trt_new == "Cycling") %>% .$sessions %>% median(na.rm = TRUE)` sessions per week (range = `r data %>% filter(trt_new == "Cycling") %>% .$sessions %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(trt_new == "Cycling") %>% .$sessions %>% range(na.rm = TRUE) %>% .[2]`), and a median duration of `r data %>% filter(trt_new == "Cycling") %>% .$duration_weeks %>% median(na.rm = TRUE)` weeks (range = `r data %>% filter(trt_new == "Cycling") %>% .$duration_weeks %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(trt_new == "Cycling") %>% .$duration_weeks %>% range(na.rm = TRUE) %>% .[2]`). Resistance-based interventions (`r data %>% filter(agent == "Resistance") %>% nrow()` data points) had a median time per session of `r data %>% filter(agent == "Resistance") %>% .$time_session %>% median(na.rm = TRUE)` min (range = `r data %>% filter(agent == "Resistance") %>% .$time_session %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(agent == "Resistance") %>% .$time_session %>% range(na.rm = TRUE) %>% .[2]`), a median frequency of `r data %>% filter(agent == "Resistance") %>% .$sessions %>% median(na.rm = TRUE)` sessions per week (range = `r data %>% filter(agent == "Resistance") %>% .$sessions %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(agent == "Resistance") %>% .$sessions %>% range(na.rm = TRUE) %>% .[2]`), and a median duration of `r data %>% filter(agent == "Resistance") %>% .$duration_weeks %>% median(na.rm = TRUE)` weeks (range = `r data %>% filter(agent == "Resistance") %>% .$duration_weeks %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(agent == "Resistance") %>% .$duration_weeks %>% range(na.rm = TRUE) %>% .[2]`). Multicomponent-based interventions (`r data %>% filter(agent == "Multicomponent") %>% nrow()` data points) had a median time per session of `r data %>% filter(agent == "Multicomponent") %>% .$time_session %>% median(na.rm = TRUE)` min (range = `r data %>% filter(agent == "Multicomponent") %>% .$time_session %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(agent == "Multicomponent") %>% .$time_session %>% range(na.rm = TRUE) %>% .[2]`), a median frequency of `r data %>% filter(agent == "Multicomponent") %>% .$sessions %>% median(na.rm = TRUE)` sessions per week (range = `r data %>% filter(agent == "Multicomponent") %>% .$sessions %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(agent == "Multicomponent") %>% .$sessions %>% range(na.rm = TRUE) %>% .[2]`), and a median duration of `r data %>% filter(agent == "Multicomponent") %>% .$duration_weeks %>% median(na.rm = TRUE)` weeks (range = `r data %>% filter(agent == "Multicomponent") %>% .$duration_weeks %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(agent == "Multicomponent") %>% .$duration_weeks %>% range(na.rm = TRUE) %>% .[2]`). Stretching-based interventions (`r data %>% filter(agent == "Stretching") %>% nrow()` data points) had a median time per session of `r data %>% filter(agent == "Stretching") %>% .$time_session %>% median(na.rm = TRUE)` min (range = `r data %>% filter(agent == "Stretching") %>% .$time_session %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(agent == "Stretching") %>% .$time_session %>% range(na.rm = TRUE) %>% .[2]`), a median frequency of `r data %>% filter(agent == "Stretching") %>% .$sessions %>% median(na.rm = TRUE)` sessions per week (range = `r data %>% filter(agent == "Stretching") %>% .$sessions %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(agent == "Stretching") %>% .$sessions %>% range(na.rm = TRUE) %>% .[2]`), and a median duration of `r data %>% filter(agent == "Stretching") %>% .$duration_weeks %>% median(na.rm = TRUE)` weeks (range = `r data %>% filter(agent == "Stretching") %>% .$duration_weeks %>% range(na.rm = TRUE) %>% .[1]` - `r data %>% filter(agent == "Stretching") %>% .$duration_weeks %>% range(na.rm = TRUE) %>% .[2]`).


## Exploratory Data Analysis

It is recommended to explore the potential association between the variables that we'll introduce in our model in order to fit one model function or another.

```{r, include=TRUE, message=FALSE, warning=FALSE}
# Linear dose-response function considering different baseline levels
data %>%
  mutate(baseline = case_when(baseline_glyc < 6.5 ~ 6,
                              baseline_glyc >= 6.5 & baseline_glyc <  7.5 ~ 7,
                              baseline_glyc >= 7.5 &  baseline_glyc < 8.5 ~ 8,
                              baseline_glyc >= 8.5 &  baseline_glyc < 9.5 ~ 9,
                              baseline_glyc >= 9.5 ~ 10)) %>%
  filter(baseline != 10) %>% # few data points that distort the plot
  ggplot(aes(x = dose_by_100, y = y)) +
  facet_grid(cols = vars(baseline)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "Mean change in HbA1c (%)",
       x = "Dose (METs-min/week)") +
  scale_y_continuous(breaks = seq(-2, 2, 0.5)) +
  scale_x_continuous(breaks = seq(0, 2500, 500))

# Spline dose-response function considering different baseline levels
data %>%
  mutate(baseline = case_when(baseline_glyc < 6.5 ~ 6,
                              baseline_glyc >= 6.5 & baseline_glyc <  7.5 ~ 7,
                              baseline_glyc >= 7.5 &  baseline_glyc < 8.5 ~ 8,
                              baseline_glyc >= 8.5 &  baseline_glyc < 9.5 ~ 9,
                              baseline_glyc >= 9.5 ~ 10)) %>%
  filter(baseline != 10) %>% # few data points that distort the plot
  ggplot(aes(x = dose_by_100, y = y)) +
  facet_grid(cols = vars(baseline)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ splines::bs(x, 3)) +
  labs(y = "Mean change in HbA1c (%)",
       x = "Dose (METs-min/week)") +
  scale_y_continuous(breaks = seq(-2, 2, 0.5)) +
  scale_x_continuous(breaks = seq(0, 2500, 500))

# visualization of weeks-response trend
data %>%
  filter(duration_weeks < 50) %>%
  ggplot(aes(duration_weeks, y)) +
  geom_point() +
  geom_smooth() +
  geom_hline(yintercept = 0, col = "red", alpha = 0.8) +
  labs(x = "Duration (weeks)",
       y = "HbA1c (%) reduction")
```

Splines allow a more flexible fitting, showing a more sensible data adjusting.


# Model fitting

Guided by Harrer (2021), we are going to fit a Bayesian meta-analysis model using the formula `response | se(se_response) ~ 1 + predictors + (1 | grouping variable)`, where our response variable is the mean difference in HbA1c (%), predicted by the glycemic baseline level and the weekly energy expenditure (METs-min/week), and maintaining the clusterisation of the effect sizes within studies (`studyID` as grouping variable). We'll fit three models considering the potential behaviors of these variables: 

  + Modeling the predictors as linear predictors.
  
  + Combining linear and non-linear (i.e., cubic spline) predictors.
  
  + Modeling the predictors with non-linear functions (i.e., cubic splines).
  

```{r, message=FALSE, warning=FALSE, results='hide', eval=FALSE}
set.seed(18112022)
# fitting a linear model
model <- brm(y | se(se) ~ 1 + baseline_glyc + weekly_dose + (1 | studyID),
             data = data, 
             control = list(adapt_delta = 0.99))

# fitting a spline interaction by dose
model.s <- brm(y | se(se) ~ 1 + baseline_glyc + s(weekly_dose, k = 4) + (1 | studyID),
             data = data, 
             control = list(adapt_delta = 0.99))

# fitting a spline interaction by baseline level and dose
model.2s <- brm(y | se(se) ~ 1 + s(baseline_glyc, k = 3) + s(weekly_dose, k = 3) + (1 | studyID), # 4 knots are great
             data = data, 
             control = list(adapt_delta = 0.99))

# fitting a spline interaction by baseline level and dose
model.2s. <- brm(y | se(se) ~ 1 + s(baseline_glyc, k = 4) + s(weekly_dose, k = 4) + (1 | studyID), # 4 knots are great
             data = data, 
             control = list(adapt_delta = 0.99))

# fitting splines interactions by baseline, dose and duration
## adding week variable - model 1
model.week <- brm(y | se(se) ~ 1 + s(baseline_glyc, k = 3) + s(weekly_dose, k = 3) + s(duration_weeks, k = 3) + (1 | studyID),
                  data = data,
                  control = list(adapt_delta = 0.99)) # save_pars = save_pars(all = TRUE) for Bayes factor computation
```


## Model comparison

```{r, warning=FALSE, message=FALSE, eval=FALSE}
# models including baseline and dose variables
loo_compare(loo(model), loo(model.s), 
            loo(model.2s), loo(model.2s.))

# models including baseline, dose and intervention duration variables
# loo_compare(loo(model.week), loo(model.week.1))
```

The models with 4 knots presented the best fitted. 


## Models including the interaction term `baseline_glyc:weekly_dose`

```{r, warning=FALSE, results='hide', message=FALSE}
# linear interaction
model.interaction <-  brm(y | se(se) ~ 1 + 
                           s(baseline_glyc, k = 4) + 
                           s(weekly_dose, k = 4) + 
                           baseline_glyc * weekly_dose +
                           (1 | studyID), # 4 knots are great
                           data = data.rob, 
                           control = list(adapt_delta = 0.99),
                           iter = 4000,
                           warmup = 1000)

# non-linear interaction
model.interaction.2 <- brm(y | se(se) ~ 1 + 
                               s(baseline_glyc, k = 4) + 
                               s(weekly_dose, k = 4) +
                               (1 | studyID), 
                               bf(y | se(se) ~ baseline_glyc * weekly_dose, nl = TRUE),
                               data = data, ############ low rob dataset
                               family = gaussian(),
                               prior = prior(normal(0, 2)), 
                               control = list(adapt_delta = 0.99),
                               iter = 4000, warmup = 1000)
```


### Model comparison

```{r, warning=FALSE, message=FALSE}
# WAIC criterion
model.interaction <- add_criterion(model.interaction, "waic")
model.interaction.2 <- add_criterion(model.interaction.2, "waic")

# comparison
loo_compare(model.interaction, model.interaction.2,
            criterion = "waic")

# LOO criterion
loo_compare(loo(model.interaction), loo(model.interaction.2))
```

Model fit parameters indicated that our `model.interaction.2` reached the convergence and showed a better fit.


### Observing conditional effects of our interaction

To observe the conditional effects of the interaction term could be an useful way to detect how these two variables behave between them. First, we are going to plot our "ordered" interaction. Next, we will plot the inverse interaction.

```{r, conditional_effects, warning=FALSE}
# conditional effects
plot(conditional_effects(model.interaction.2,
                         effects = "baseline_glyc:weekly_dose",
                         int_conditions = list(weekly_dose = c(600, 1200, 1800))),
     line_args = c(alpha = 0.2))

# inverse interaction
plot(conditional_effects(model.interaction.2,
                         effects = "weekly_dose:baseline_glyc",
                         int_conditions = list(baseline_glyc = c(6, 7, 8, 10))),
     line_args = c(alpha = 0.2))
```

We observe that an optimal dose exists, and it's very similar for different baseline levels.


Next,we are going to conduct our data analysis in four different parts:

  +   Chapter 1: overall effect of overall physical activity in HbA1c (%) change.
  
  +   Chapter 2: effects of different physical activity doses expressed as **energy expenditure** (METs-min/week) in HbA1c change adjusted by baseline level.
  
  +   Chapter 3: effects of different physical activity doses in HbA1c change adjusted by baseline level and intervention duration (weeks).
  
  +   Chapter 4: effects of different physical activity interventions in HbA1c change adjusted by dose and baseline level. 
  

# Chapter 1: Overall effect of physical activity 

First and foremost, we have to create a data frame including our posterior predictive distributions from our selected model.

```{r}
# prediction model
tidy.model <- model.2s. %>%
  epred_draws(newdata = expand_grid(weekly_dose = seq(0, 1800, 50),
                                    baseline_glyc = seq(5.7, 10, 0.1),
                                    se = mean(data$se)),
              re_formula = ~ 1)
```


Now, we just plot the predicted dose-response between physical activity dose and HbA1c change.

```{r, echo=FALSE}
tidy.model %>%
  ggplot(aes(x = weekly_dose, y = .epred)) +
  stat_lineribbon() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = -0.5, col = "red", alpha = 0.6, linetype = 2) +
  scale_fill_brewer(palette = "Greys") +
  labs(x = "Dose (METs-min/week)",
       y = "Predicted change in HbA1c (%)",
       fill = "Credible interval") +
  scale_x_continuous(breaks = seq(0, 1800, 300)) +
  scale_y_continuous(breaks = seq(-2, 2, 0.25)) +
  theme(legend.position = "bottom") +
  theme_tidybayes() +
  panel_border()
```


We observe a great variability in the responses. Evidence presents a reduction of **-0.5%** in the glycemia level as a clinically significant change, and all doses included this value in their credible intervals, which means that is likely that in future interventions, a person with diabetes would not reach a clinical response. That is controversial with meta-analytic evidence, and our hypothesis pointed that the baseline level of the person is a potential effect modifier, causing different effects in HbA1c regulation. Let's check this out.

```{r, echo=FALSE}
# plotting the expectation of the posterior predictive distribution of the response variable
tidy.model %>%
  ggplot(aes(weekly_dose, baseline_glyc, fill = .epred)) +
  geom_raster(interpolate = TRUE) +
  geom_contour2(aes(x = weekly_dose, y = baseline_glyc, z = .epred), col = "black",
                breaks = seq(-1.5, 0.4, 0.1)) +
  geom_text_contour(aes(z = .epred), stroke = 0.2, size = 4.5, skip = 0,
                    label.placer = label_placer_n(1), min.size = 1) +
  # geom_line(data = tidy_epred %>%
  # filter(round(.epred, 4) == -0.5), aes(x = dose_by_100, y = baseline_glyc), col = "red") +
  scale_fill_gradientn(colours = colorspace::heat_hcl(7)) + # another option is scale_fill_viridis_c(option = "magma")
  theme_tidybayes() +
  panel_border() +
  labs(x = "Dose (METs-min/week)",
       y = "Baseline HbA1c level",
       fill = "Predicted\nchange") +
  scale_x_continuous(breaks = seq(0, 1800, 200)) +
  scale_y_continuous(breaks = seq(6, 10, 0.5))
```


# Contour plots for different ADA categories

First, we have to create this classification.

```{r}
tidy.model <- tidy.model %>%
  mutate(baseline = case_when(
    baseline_glyc < 6.5 ~ "Prediabetes",
    baseline_glyc >= 6.5 & baseline_glyc <= 7 ~ "Controlled T2DM",
    baseline_glyc > 7.0 & baseline_glyc <= 8 ~ "Uncontrolled T2DM",
    baseline_glyc > 8 ~ "Severe uncontrolled T2DM"
  )) %>% # so strange that 30 values were NAs; after revise them, all belonged to the controlled category 
  mutate(baseline = ifelse(is.na(baseline) == TRUE, "Uncontrolled T2DM", baseline)) %>%
  mutate(baseline = factor(baseline, levels = c("Prediabetes",
                                                "Controlled T2DM",
                                                "Uncontrolled T2DM",
                                                "Severe uncontrolled T2DM")))
```


## Prediabetes

```{r}
pre_plot <- tidy.model %>%
  filter(baseline == "Prediabetes") %>%
  ggplot(aes(weekly_dose, baseline_glyc, fill = .epred)) +
  geom_raster(interpolate = TRUE) +
  geom_contour2(aes(x = weekly_dose, y = baseline_glyc, z = .epred), col = "black",
                breaks = seq(-1.5, 0.4, 0.1)) +
  geom_text_contour(aes(z = .epred), stroke = 0.2, size = 4.5, skip = 0,
                    label.placer = label_placer_n(1), min.size = 1) +
  # geom_line(data = tidy_epred %>%
  # filter(round(.epred, 4) == -0.5), aes(x = dose_by_100, y = baseline_glyc), col = "red") +
  scale_fill_gradientn(colours = colorspace::heat_hcl(7)) + # another option is scale_fill_viridis_c(option = "magma")
  theme_tidybayes() +
  panel_border() +
  labs(x = "Dose (METs-min/week)",
       y = "Baseline HbA1c level",
       fill = "Predicted\nchange",
       title = "Prediabetes") +
  scale_x_continuous(breaks = seq(0, 1800, 200)) +
  scale_y_continuous(breaks = seq(5.7, 7, 0.1)) +
  theme(plot.title = element_text(face = "bold"))
```


## Controlled T2DM

```{r}
cont_plot <- tidy.model %>%
  filter(baseline == "Controlled T2DM") %>%
  ggplot(aes(weekly_dose, baseline_glyc, fill = .epred)) +
  geom_raster(interpolate = TRUE) +
  geom_contour2(aes(x = weekly_dose, y = baseline_glyc, z = .epred), col = "black",
                breaks = seq(-1.5, 0.4, 0.1)) +
  geom_text_contour(aes(z = .epred), stroke = 0.2, size = 4.5, skip = 0,
                    label.placer = label_placer_n(1), min.size = 1) +
  # geom_line(data = tidy_epred %>%
  # filter(round(.epred, 4) == -0.5), aes(x = dose_by_100, y = baseline_glyc), col = "red") +
  scale_fill_gradientn(colours = colorspace::heat_hcl(7)) + # another option is scale_fill_viridis_c(option = "magma")
  theme_tidybayes() +
  panel_border() +
  labs(x = "Dose (METs-min/week)",
       y = "Baseline HbA1c level",
       fill = "Predicted\nchange",
       title = "Controlled T2DM") +
  scale_x_continuous(breaks = seq(0, 1800, 200)) +
  scale_y_continuous(breaks = seq(6, 8, 0.1)) +
  theme(plot.title = element_text(face = "bold"))
```


## Uncontrolled T2DM

```{r}
unc_plot <- tidy.model %>%
  filter(baseline == "Uncontrolled T2DM") %>%
  ggplot(aes(weekly_dose, baseline_glyc, fill = .epred)) +
  geom_raster(interpolate = TRUE) +
  geom_contour2(aes(x = weekly_dose, y = baseline_glyc, z = .epred), col = "black",
                breaks = seq(-1.5, 0.4, 0.1)) +
  geom_text_contour(aes(z = .epred), stroke = 0.2, size = 4.5, skip = 0,
                    label.placer = label_placer_n(1), min.size = 1) +
  # geom_line(data = tidy_epred %>%
  # filter(round(.epred, 4) == -0.5), aes(x = dose_by_100, y = baseline_glyc), col = "red") +
  scale_fill_gradientn(colours = colorspace::heat_hcl(7)) + # another option is scale_fill_viridis_c(option = "magma")
  theme_tidybayes() +
  panel_border() +
  labs(x = "Dose (METs-min/week)",
       y = "Baseline HbA1c level",
       fill = "Predicted\nchange",
       title = "Uncontrolled T2DM") +
  scale_x_continuous(breaks = seq(0, 1800, 200)) +
  scale_y_continuous(breaks = seq(6, 9, 0.1)) +
  theme(plot.title = element_text(face = "bold"))
```


## Severe uncontrolled T2DM

```{r}
sev_plot <- tidy.model %>%
  filter(baseline == "Severe uncontrolled T2DM") %>%
  ggplot(aes(weekly_dose, baseline_glyc, fill = .epred)) +
  geom_raster(interpolate = TRUE) +
  geom_contour2(aes(x = weekly_dose, y = baseline_glyc, z = .epred), col = "black",
                breaks = seq(-1.5, 0.4, 0.1)) +
  geom_text_contour(aes(z = .epred), stroke = 0.2, size = 4.5, skip = 0,
                    label.placer = label_placer_n(1), min.size = 1) +
  # geom_line(data = tidy_epred %>%
  # filter(round(.epred, 4) == -0.5), aes(x = dose_by_100, y = baseline_glyc), col = "red") +
  scale_fill_gradientn(colours = colorspace::heat_hcl(7)) + # another option is scale_fill_viridis_c(option = "magma")
  theme_tidybayes() +
  panel_border() +
  labs(x = "Dose (METs-min/week)",
       y = "Baseline HbA1c level",
       fill = "Predicted\nchange",
       title = "Severe uncontrolled T2DM") +
  scale_x_continuous(breaks = seq(0, 1800, 200)) +
  scale_y_continuous(breaks = seq(6, 10, 0.1)) +
  theme(plot.title = element_text(face = "bold"))
```

```{r}
(pre_plot | con_plot) /
  (unc_plot | sev_plot)
```


We are going to display for each ADA category the minimal effective dose to reach a new-lower ADA category, and the minimal statistical effective and optimal dose for each specific baseline point.


### Severe uncontrolled T2DM data

#### Minimal effective doses to reach the new category

```{r}
tidy.model %>%
  filter(baseline == "Severe uncontrolled T2DM") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  mutate(check = case_when(
    baseline_glyc == 8.1 & upper <= -0.1 ~ TRUE,
    baseline_glyc == 8.2 & upper <= -0.2 ~ TRUE,
    baseline_glyc == 8.3 & upper <= -0.3 ~ TRUE,
    baseline_glyc == 8.4 & upper <= -0.4 ~ TRUE,
    baseline_glyc == 8.5 & upper <= -0.5 ~ TRUE,
    baseline_glyc == 8.6 & upper <= -0.6 ~ TRUE,
    baseline_glyc == 8.7 & upper <= -0.7 ~ TRUE,
    baseline_glyc == 8.8 & upper <= -0.8 ~ TRUE,
    baseline_glyc == 8.9 & upper <= -0.9 ~ TRUE,
    baseline_glyc == 9 & upper <= -1 ~ TRUE,
    baseline_glyc == 9.1 & upper <= -1.1 ~ TRUE,
    baseline_glyc == 9.2 & upper <= -1.2 ~ TRUE,
    baseline_glyc == 9.3 & upper <= -1.3 ~ TRUE,
    baseline_glyc == 9.4 & upper <= -1.4 ~ TRUE,
    baseline_glyc == 9.5 & upper <= -1.5 ~ TRUE,
    baseline_glyc == 9.6 & upper <= -1.6 ~ TRUE,
    baseline_glyc == 9.7 & upper <= -1.7 ~ TRUE,
    baseline_glyc == 9.8 & upper <= -1.8 ~ TRUE,
    baseline_glyc == 9.9 & upper <= -1.9 ~ TRUE,
    baseline_glyc == 10 & upper <= -2 ~ TRUE
  )) %>%
  filter(check == TRUE) %>%
  group_by(baseline_glyc) %>%
  filter(pred == max(pred))
```


#### Minimal statistical effective doses

```{r}
tidy.model %>%
  filter(baseline == "Severe uncontrolled T2DM") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(baseline_glyc) %>%
  filter(upper < 0) %>%
  filter(!duplicated(baseline_glyc))
```


#### Optimal doses

```{r}
tidy.model %>%
  filter(baseline == "Severe uncontrolled T2DM") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(baseline_glyc) %>%
  filter(pred == min(pred))
```


### Uncontrolled T2DM data

#### Minimal effective doses to reach the new category

```{r}
tidy.model %>%
  filter(baseline == "Uncontrolled T2DM") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  mutate(check = case_when(
    baseline_glyc == 7.1 & upper <= -0.1 ~ TRUE,
    baseline_glyc == 7.2 & upper <= -0.2 ~ TRUE,
    baseline_glyc == 7.3 & upper <= -0.3 ~ TRUE,
    baseline_glyc == 7.4 & upper <= -0.4 ~ TRUE,
    baseline_glyc == 7.5 & upper <= -0.5 ~ TRUE,
    baseline_glyc == 7.6 & upper <= -0.6 ~ TRUE,
    baseline_glyc == 7.7 & upper <= -0.7 ~ TRUE,
    baseline_glyc == 7.8 & upper <= -0.8 ~ TRUE,
    baseline_glyc == 7.9 & upper <= -0.9 ~ TRUE,
    baseline_glyc == 8 & upper <= -1 ~ TRUE
  )) %>%
  filter(check == TRUE) %>%
  group_by(baseline_glyc) %>%
  filter(pred == max(pred))
```


#### Minimal statistical effective doses

```{r}
tidy.model %>%
  filter(baseline == "Uncontrolled T2DM") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(baseline_glyc) %>%
  filter(upper < 0) %>%
  filter(!duplicated(baseline_glyc))
```


#### Optimal doses

```{r}
tidy.model %>%
  filter(baseline == "Uncontrolled T2DM") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(baseline_glyc) %>%
  filter(pred == min(pred))
```


### Controlled T2DM data

#### Minimal effective doses to reach the new category

```{r}
tidy.model %>%
  filter(baseline == "Controlled T2DM") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  mutate(check = case_when(
    baseline_glyc == 6.5 & upper <= -0.05 ~ TRUE,
    baseline_glyc == 6.6 & upper <= -0.15 ~ TRUE,
    baseline_glyc == 6.7 & upper <= -0.25 ~ TRUE,
    baseline_glyc == 6.8 & upper <= -0.35 ~ TRUE,
    baseline_glyc == 6.9 & upper <= -0.45 ~ TRUE,
    baseline_glyc == 7 & upper <= -0.55 ~ TRUE
  )) %>%
  filter(check == TRUE) %>%
  group_by(baseline_glyc) %>%
  filter(pred == max(pred))
```


#### Minimal statistical effective doses

```{r}
tidy.model %>%
  filter(baseline == "Controlled T2DM") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(baseline_glyc) %>%
  filter(upper < 0) %>%
  filter(!duplicated(baseline_glyc))
```


#### Optimal doses

```{r}
tidy.model %>%
  filter(baseline == "Controlled T2DM") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(baseline_glyc) %>%
  filter(pred == min(pred))
```


### Prediabetes data

#### Minimal effective doses to reach the new category

```{r}
tidy.model %>%
  filter(baseline == "Prediabetes") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  mutate(check = case_when(
    baseline_glyc == 5.7 & upper <= -0.05 ~ TRUE,
    baseline_glyc == 5.8 & upper <= -0.15 ~ TRUE,
    baseline_glyc == 5.9 & upper <= -0.25 ~ TRUE,
    baseline_glyc == 6 & upper <= -0.35 ~ TRUE,
    baseline_glyc == 6.1 & upper <= -0.45 ~ TRUE,
    baseline_glyc == 6.2 & upper <= -0.55 ~ TRUE,
    baseline_glyc == 6.3 & upper <= -0.65 ~ TRUE,
    baseline_glyc == 6.4 & upper <= -0.75 ~ TRUE
  )) %>%
  filter(check == TRUE) %>%
  group_by(baseline_glyc) %>%
  filter(pred == max(pred))
```


#### Minimal statistical effective doses

```{r}
tidy.model %>%
  filter(baseline == "Prediabetes") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(baseline_glyc) %>%
  filter(upper < 0) %>%
  filter(!duplicated(baseline_glyc))
```


#### Optimal doses

```{r}
tidy.model %>%
  filter(baseline == "Prediabetes") %>%
  group_by(baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(baseline_glyc) %>%
  filter(pred == min(pred))
```



# Chapter 2: Overal physical activity effects adjusting by baseline level

In the former visualization, it is not possible to observe the uncertainty in the estimates, so we are going to predict the dose-response relationships between physical activity dose and HbA1c change adjusting by baseline level. Here we can make the predictions attending to two methods: 1) categorizing the baseline levels based on the American Diabetes Association (ADA) cut-points (i.e., *prediabetes* if the person had less than 6.5% of baseline level; *controlled diabetes* if had between 6.5 and 7%; and *uncontrolled diabetes* if had between 7 and 8%; or *severe uncontrolled diabetes* if had more than 8%); and 2) making specific baseline level points' predictions (e.g., predict the dose-response relationship for a person with a baseline level of 8%).

### Categorizing by ADA cut-points

```{r, fig.height=10, fig.width=15, echo=FALSE}
# plotting
tidy.model %>%
  mutate(baseline = case_when(
    baseline_glyc < 6.5 ~ "Prediabetes",
    baseline_glyc %in% seq(6.5, 7, 0.01) ~ "Controlled T2DM",
    baseline_glyc %in% seq(7.01, 8, 0.01) ~ "Uncontrolled T2DM",
    baseline_glyc > 8 ~ "Severe uncontrolled T2DM"
  )) %>%
  mutate(baseline = ifelse(is.na(baseline) == TRUE, "Uncontrolled T2DM", baseline)) %>%
  mutate(baseline = factor(baseline, levels = c("Prediabetes",
                                                "Controlled T2DM",
                                                "Uncontrolled T2DM",
                                                "Severe uncontrolled T2DM"))) %>%
  ggplot(aes(x = weekly_dose, y = .epred)) +
  facet_wrap(~ baseline, scales = "free") +
  stat_lineribbon() +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_hline(yintercept = -0.5, col = "red", alpha = 0.6, linetype = 2) +
  scale_fill_brewer(palette = "Greys") +
  labs(x = "Dose (METs-min/week)",
       y = "Predicted change in HbA1c (%)",
       fill = "Credible interval") +
  scale_x_continuous(breaks = seq(0, 1800, 300)) +
  scale_y_continuous(breaks = seq(-1.5, 1, 0.25)) +
  theme(legend.position = "bottom")
```


A *clinically* significant reduction in HbA1c levels can be detected in both classes of uncontrolled DMT2 patients. Interestingly, this *clinical* effect should be revised taken into consideration the clinical implications that have a reduction of **0.5%** in a person with an uncontrolled diabetes and a reduction of **-0.2%** in a prediabetic person. In summary, all classes of DMT2 could benefit from physical activity when a specific dose would be applied. Anyway, the cut-points where a *clinical* effect is achieved are displayed below.

```{r, include=TRUE}
# Minimal effective doses (clinically significant)
tidy.model %>%
  mutate(baseline = case_when(
    baseline_glyc < 6.5 ~ "Prediabetes",
    baseline_glyc %in% seq(6.5, 7, 0.01) ~ "Controlled T2DM",
    baseline_glyc %in% seq(7.01, 8, 0.01) ~ "Uncontrolled T2DM",
    baseline_glyc > 8 ~ "Severe uncontrolled T2DM"
  )) %>%
  mutate(baseline = ifelse(is.na(baseline) == TRUE, "Uncontrolled T2DM", baseline)) %>%
  mutate(baseline = factor(baseline, levels = c("Prediabetes",
                                                "Controlled T2DM",
                                                "Uncontrolled T2DM",
                                                "Severe uncontrolled T2DM"))) %>%
  group_by(baseline, weekly_dose) %>%
  summarise(mean = mean(.epred),
            sd = sd(.epred),
            lower = mean - qnorm(0.975)*sd,
            upper = mean + qnorm(0.975)*sd) %>%
  filter(upper <= -0.4999) %>% 
  mutate_if(is.numeric, round, 3) %>%
  arrange(weekly_dose) %>%
  filter(!duplicated(baseline)) %>%
  as.data.frame()


# Optimal clinically effective doses by baseline levels 
tidy.model %>%
  mutate(baseline = case_when(
    baseline_glyc < 6.5 ~ "Prediabetes",
    baseline_glyc %in% seq(6.5, 7, 0.01) ~ "Controlled T2DM",
    baseline_glyc %in% seq(7.01, 8, 0.01) ~ "Uncontrolled T2DM",
    baseline_glyc > 8 ~ "Severe uncontrolled T2DM"
  )) %>%
  mutate(baseline = ifelse(is.na(baseline) == TRUE, "Uncontrolled T2DM", baseline)) %>%
  mutate(baseline = factor(baseline, levels = c("Prediabetes",
                                                "Controlled T2DM",
                                                "Uncontrolled T2DM",
                                                "Severe uncontrolled T2DM"))) %>%
  group_by(baseline, weekly_dose) %>%
  summarise(mean = mean(.epred),
            sd = sd(.epred),
            lower = mean - qnorm(0.975)*sd,
            upper = mean + qnorm(0.975)*sd) %>%
  filter(upper <= -0.4999) %>% 
  mutate_if(is.numeric, round, 3) %>%
  arrange(mean) %>%
  filter(!duplicated(baseline)) %>%
  as.data.frame()



# Full range of clinically effective doses by baseline levels
tidy.model %>%
  mutate(baseline = case_when(
    baseline_glyc < 6.5 ~ "Prediabetes",
    baseline_glyc %in% seq(6.5, 7, 0.01) ~ "Controlled T2DM",
    baseline_glyc %in% seq(7.01, 8, 0.01) ~ "Uncontrolled T2DM",
    baseline_glyc > 8 ~ "Severe uncontrolled T2DM"
  )) %>%
  mutate(baseline = ifelse(is.na(baseline) == TRUE, "Uncontrolled T2DM", baseline)) %>%
  mutate(baseline = factor(baseline, levels = c("Prediabetes",
                                                "Controlled T2DM",
                                                "Uncontrolled T2DM",
                                                "Severe uncontrolled T2DM"))) %>%
  group_by(baseline, weekly_dose) %>%
  summarise(mean = mean(.epred),
            sd = sd(.epred),
            lower = mean - qnorm(0.975)*sd,
            upper = mean + qnorm(0.975)*sd) %>%
  filter(upper <= -0.4999) %>% 
  mutate_if(is.numeric, round, 3) %>%
  as.data.frame()
```


# Chapter 4: Intervention-specific effects adjusting by physical activity dose and baseline level

In the previous analyses we have shown that the baseline level and the accumulated dose are important variables to take in consideration when a physical activity program is applied, but what about the **type** of activity? Is similar to do strength activities than walking? Let's check this out!

First, we have to set up our **final** classification of our interventions. As we want to be the more informative as possible, we classify the interventions mainly attending to the number of data points. For each intervention, we'll plot the expectations of the mean posterior distributions and the posterior predictions considering the different baseline levels aforementioned.


### Setting up our final intervention classification

```{r}
data %>%
  mutate(trt_new = case_when(
    trt %in% c("Aerobic + Resistance + Balance exercises", "Aerobic + Resistance exercises") ~ "Multicomponent",
    trt %in% c("Cycling") ~ "Cycling",
    trt %in% c("HIIT") ~ "HIIT",
    trt %in% c("IMT", "Resistance exercises", "WBV") ~ "Strength",
    trt %in% c("Mind-body training") ~ "Mind-body",
    trt %in% c("Mixed aerobic exercises") ~ "Mixed aerobic activities",
    trt == "Stretching" ~ "Stretching",
    trt == "Usual care" ~ "Usual care",
    trt == "Running" ~ "Running",
    trt == "Walking" ~ "Walking"
  )) %>%
  .$trt_new %>%
  janitor::tabyl() %>%
  arrange(desc(n))
```

```{r, echo=FALSE}
data <- data %>%
  mutate(trt_new = case_when(
    trt %in% c("Aerobic + Resistance + Balance exercises", "Aerobic + Resistance exercises") ~ "Multicomponent",
    trt %in% c("Cycling") ~ "Cycling",
    trt %in% c("HIIT") ~ "HIIT",
    trt %in% c("IMT", "Resistance exercises", "WBV") ~ "Strength",
    trt %in% c("Mind-body training") ~ "Mind-body",
    trt %in% c("Mixed aerobic exercises") ~ "Mixed aerobic activities",
    trt == "Stretching" ~ "Stretching",
    trt == "Usual care" ~ "Usual care",
    trt == "Running" ~ "Running",
    trt == "Walking" ~ "Walking"
  )) %>%
  mutate(trt_new = factor(trt_new, levels = c("Usual care",
                                              "Strength",
                                              "Multicomponent",
                                              "Walking",
                                              "Mixed aerobic activities",
                                              "Cycling",
                                              "HIIT",
                                              "Mind-body",
                                              "Stretching",
                                              "Running")))
```

Nice! It's time to fit our model using the final classification.


### Fitting our intervention-specific model

```{r, message=FALSE, warning=FALSE, results='hide'}
set.seed(12122022)
# fitting intervention-specific model adding trt_new as grouping variable 
model.int <- brm(y | se(se) ~ 1 + s(baseline_glyc, k = 4) + s(weekly_dose, k = 4) + trt_new +
                   (1 | studyID),
                   bf(y | se(se) ~ 1 + baseline_glyc * weekly_dose, nl = TRUE),
                   family = gaussian(),
                   prior = prior(normal(0, 5)),
                   data = data, 
                   control = list(adapt_delta = 0.99))

# we fitted some more models but this is the one that presented the best fit
```

```{r}
library(marginaleffects)
# contrast estimates: pairwise comparisons

## general contrast estimates (i.e., by agents)
table <- comparisons(model.int, 
            newdata = datagrid(trt_new = unique(data$trt_new),
                               weekly_dose = seq(0, 1800, 300)),
            variables = list(trt_new = "pairwise")) %>%
  tidy() %>%
  filter(grepl("- Usual care", contrast)) %>%
  mutate_if(is.numeric, round, 3)


## specific contrasts (i.e., by agent, dose and baseline glycemic level)
(pred <- comparisons(model.int, 
            newdata = datagrid(trt_new = unique(data$trt_new),
                               weekly_dose = seq(0, 1800, 600),
                               baseline_glyc = seq(6, 10, 0.5)),
            variables = list(trt_new = "pairwise"),
            re_formula = NULL) %>%
  posteriordraws() %>%
  filter(grepl("- Usual care", contrast)))



# plot
pred %>%
  mutate(baseline = case_when(
    baseline_glyc == 6 ~ "Prediabetes",
    baseline_glyc %in% c(6.5, 7) ~ "Controlled T2DM",
    baseline_glyc %in% c(7.5, 8) ~ "Uncontrolled T2DM",
    baseline_glyc > 8 ~ "Severe uncontrolled T2DM"
  )) %>%
  filter(grepl("- Usual care", contrast)) %>%
  filter(weekly_dose != 0) %>% 
  ggplot(aes(x = predicted)) + 
  stat_halfeye(aes(fill = baseline), alpha = 0.4) +
  geom_vline(xintercept = 0, col = "black", linetype = 2, size = 0.5, alpha = 0.5) +
  labs(x = "Average Treatment Effect (Intervention vs. Usual care)",
       y = "Density") +
  facet_grid(weekly_dose ~ contrast, scales = "free") +
  theme_bw() 
```



### Predictions

We could then predict how the expectations of the posterior mean responses vary across the full range of doses and differentiating by specific interventions. 

```{r, fig.height=12, fig.width=12}
# predictions
tidy_epred.int <- model.int %>%
  epred_draws(newdata = expand_grid(weekly_dose = seq(0, 1800, 50),
                                    baseline_glyc = seq(5.7, 10, 0.1),
                                    se = mean(data$se),
                                    trt_new = data %>% .$trt_new %>% unique()),
              re_formula = ~ (1 | trt_new))


## adding ADA categories
tidy_epred.int <- tidy_epred.int %>%
  mutate(baseline = case_when(
    baseline_glyc < 6.5 ~ "Prediabetes",
    baseline_glyc >= 6.5 & baseline_glyc <= 7 ~ "Controlled T2DM",
    baseline_glyc > 7.0 & baseline_glyc <= 8 ~ "Uncontrolled T2DM",
    baseline_glyc > 8 ~ "Severe uncontrolled T2DM"
  ))


# plotting the expectation of the posterior predictive distribution of response variable
pre_plot <- tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>% # excluding usual care because of the dose and stretching due to evidence-based decision
  filter(baseline == "Prediabetes") %>%
  ggplot(aes(weekly_dose, baseline_glyc, fill = .epred)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(aes(x = weekly_dose, y = baseline_glyc, z = .epred), col = "black",
                breaks = seq(-1, 0.4, 0.1)) +
  geom_text_contour(aes(z = .epred), stroke = 0.2, size = 3, skip = 0,
                    label.placer = label_placer_n(1), min.size = 1) +
  # geom_line(data = tidy_epred %>%
  # filter(round(.epred, 4) == -0.5), aes(x = weekly_dose, y = baseline_glyc), col = "red") +
  scale_fill_gradientn(colours = colorspace::heat_hcl(7)) + # scale_fill_viridis_c(option = "magma") +
  facet_wrap(~ trt_new, scales = "free") +
  theme_tidybayes() +
  panel_border() +
  labs(x = "Dose (METs-min/week)",
       y = "Baseline HbA1c level",
       fill = "Predicted\nchange",
       title = "Prediabetes") +
  scale_x_continuous(breaks = seq(0, 1800, 200)) +
  scale_y_continuous(breaks = seq(5.7, 6.5, 0.1)) +
  theme(plot.title = element_text(face = "bold"))

# controlled
con_plot <- tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>% # excluding usual care because of the dose and stretching due to evidence-based decision
  filter(baseline == "Controlled T2DM") %>%
  ggplot(aes(weekly_dose, baseline_glyc, fill = .epred)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(aes(x = weekly_dose, y = baseline_glyc, z = .epred), col = "black",
                breaks = seq(-1, 0.4, 0.1)) +
  geom_text_contour(aes(z = .epred), stroke = 0.2, size = 3, skip = 0,
                    label.placer = label_placer_n(1), min.size = 1) +
  # geom_line(data = tidy_epred %>%
  # filter(round(.epred, 4) == -0.5), aes(x = weekly_dose, y = baseline_glyc), col = "red") +
  scale_fill_gradientn(colours = colorspace::heat_hcl(7)) + # scale_fill_viridis_c(option = "magma") +
  facet_wrap(~ trt_new, scales = "free") +
  theme_tidybayes() +
  panel_border() +
  labs(x = "Dose (METs-min/week)",
       y = "Baseline HbA1c level",
       fill = "Predicted\nchange",
       title = "Controlled T2DM") +
  scale_x_continuous(breaks = seq(0, 1800, 200)) +
  scale_y_continuous(breaks = seq(6.5, 7, 0.1)) +
  theme(plot.title = element_text(face = "bold"))

# uncontrolled
unc_plot <- tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>% # excluding usual care because of the dose and stretching due to evidence-based decision
  filter(baseline == "Uncontrolled T2DM") %>%
  ggplot(aes(weekly_dose, baseline_glyc, fill = .epred)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(aes(x = weekly_dose, y = baseline_glyc, z = .epred), col = "black",
                breaks = seq(-1, 0.4, 0.1)) +
  geom_text_contour(aes(z = .epred), stroke = 0.2, size = 3, skip = 0,
                    label.placer = label_placer_n(1), min.size = 1) +
  # geom_line(data = tidy_epred %>%
  # filter(round(.epred, 4) == -0.5), aes(x = weekly_dose, y = baseline_glyc), col = "red") +
  scale_fill_gradientn(colours = colorspace::heat_hcl(7)) + # scale_fill_viridis_c(option = "magma") +
  facet_wrap(~ trt_new, scales = "free") +
  theme_tidybayes() +
  panel_border() +
  labs(x = "Dose (METs-min/week)",
       y = "Baseline HbA1c level",
       fill = "Predicted\nchange",
       title = "Uncontrolled T2DM") +
  scale_x_continuous(breaks = seq(0, 1800, 200)) +
  scale_y_continuous(breaks = seq(7, 8, 0.1)) +
  theme(plot.title = element_text(face = "bold"))

# severe uncontrolled
sev_plot <- tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>% # excluding usual care because of the dose and stretching due to evidence-based decision
  filter(baseline == "Severe uncontrolled T2DM") %>%
  ggplot(aes(weekly_dose, baseline_glyc, fill = .epred)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(aes(x = weekly_dose, y = baseline_glyc, z = .epred), col = "black",
                breaks = seq(-1, 0.4, 0.1)) +
  geom_text_contour(aes(z = .epred), stroke = 0.2, size = 3, skip = 0,
                    label.placer = label_placer_n(1), min.size = 1) +
  # geom_line(data = tidy_epred %>%
  # filter(round(.epred, 4) == -0.5), aes(x = weekly_dose, y = baseline_glyc), col = "red") +
  scale_fill_gradientn(colours = colorspace::heat_hcl(7)) + # scale_fill_viridis_c(option = "magma") +
  facet_wrap(~ trt_new, scales = "free") +
  theme_tidybayes() +
  panel_border() +
  labs(x = "Dose (METs-min/week)",
       y = "Baseline HbA1c level",
       fill = "Predicted\nchange",
       title = "Severe uncontrolled T2DM") +
  scale_x_continuous(breaks = seq(0, 1800, 200)) +
  scale_y_continuous(breaks = seq(8, 10, 0.1)) +
  theme(plot.title = element_text(face = "bold"))



# minimal effective doses
minimal_list <- list(Prediabetes = tidy_epred.int %>%
  filter(baseline == "Prediabetes") %>%
  group_by(trt_new, baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  mutate(check = case_when(
    baseline_glyc == '5.7' & upper <= -0.05 ~ TRUE,
    baseline_glyc == '5.8' & upper <= -0.15 ~ TRUE,
    baseline_glyc == '5.9' & upper <= -0.25 ~ TRUE,
    baseline_glyc == '6' & upper <= -0.35 ~ TRUE,
    baseline_glyc == '6.1' & upper <= -0.45 ~ TRUE,
    baseline_glyc == '6.2' & upper <= -0.55 ~ TRUE,
    baseline_glyc == '6.3' & upper <= -0.65 ~ TRUE,
    baseline_glyc == '6.4' & upper <= -0.75 ~ TRUE
  )) %>%
  filter(check == TRUE) %>%
  group_by(trt_new, baseline_glyc) %>%
  filter(pred == max(pred) & trt_new != "Stretching") %>%
    mutate_if(is.numeric, round, 3),
     Controlled = tidy_epred.int %>%
  filter(baseline == "Controlled T2DM") %>%
  group_by(trt_new, baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  mutate(check = case_when(
    baseline_glyc == '6.5' & upper <= -0.05 ~ TRUE,
    baseline_glyc == '6.6' & upper <= -0.15 ~ TRUE,
    baseline_glyc == '6.7' & upper <= -0.25 ~ TRUE,
    baseline_glyc == '6.8' & upper <= -0.35 ~ TRUE,
    baseline_glyc == '6.9' & upper <= -0.45 ~ TRUE,
    baseline_glyc == '7' & upper <= -0.55 ~ TRUE
  )) %>%
  filter(check == TRUE) %>%
  group_by(trt_new, baseline_glyc) %>%
  filter(pred == max(pred) & trt_new != "Stretching") %>%
    mutate_if(is.numeric, round, 3),
  Uncontrolled = tidy_epred.int %>%
  filter(baseline == "Uncontrolled T2DM") %>%
  group_by(trt_new, baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  mutate(check = case_when(
    baseline_glyc == '7.1' & upper <= -0.1 ~ TRUE,
    baseline_glyc == '7.2' & upper <= -0.2 ~ TRUE,
    baseline_glyc == '7.3' & upper <= -0.3 ~ TRUE,
    baseline_glyc == '7.4' & upper <= -0.4 ~ TRUE,
    baseline_glyc == '7.5' & upper <= -0.5 ~ TRUE,
    baseline_glyc == '7.6' & upper <= -0.6 ~ TRUE,
    baseline_glyc == '7.7' & upper <= -0.7 ~ TRUE,
    baseline_glyc == '7.8' & upper <= -0.8 ~ TRUE,
    baseline_glyc == '7.9' & upper <= -0.9 ~ TRUE,
    baseline_glyc == '8' & upper <= -1 ~ TRUE
  )) %>%
  filter(check == TRUE) %>%
  group_by(trt_new, baseline_glyc) %>%
  filter(pred == max(pred) & trt_new != "Stretching") %>%
    mutate_if(is.numeric, round, 3),
  Severe = tidy_epred.int %>%
  filter(baseline == "Severe uncontrolled T2DM") %>%
  group_by(trt_new, baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  mutate(check = case_when(
    baseline_glyc == '8.1' & upper <= -0.1 ~ TRUE,
    baseline_glyc == '8.2' & upper <= -0.2 ~ TRUE,
    baseline_glyc == '8.3' & upper <= -0.3 ~ TRUE,
    baseline_glyc == '8.4' & upper <= -0.4 ~ TRUE,
    baseline_glyc == '8.5' & upper <= -0.5 ~ TRUE,
    baseline_glyc == '8.6' & upper <= -0.6 ~ TRUE,
    baseline_glyc == '8.7' & upper <= -0.7 ~ TRUE,
    baseline_glyc == '8.8' & upper <= -0.8 ~ TRUE,
    baseline_glyc == '8.9' & upper <= -0.9 ~ TRUE,
    baseline_glyc == '9' & upper <= -1 ~ TRUE,
    baseline_glyc == '9.1' & upper <= -1.1 ~ TRUE,
    baseline_glyc == '9.2' & upper <= -1.2 ~ TRUE,
    baseline_glyc == '9.3' & upper <= -1.3 ~ TRUE,
    baseline_glyc == '9.4' & upper <= -1.4 ~ TRUE,
    baseline_glyc == '9.5' & upper <= -1.5 ~ TRUE,
    baseline_glyc == '9.6' & upper <= -1.6 ~ TRUE,
    baseline_glyc == '9.7' & upper <= -1.7 ~ TRUE,
    baseline_glyc == '9.8' & upper <= -1.8 ~ TRUE,
    baseline_glyc == '9.9' & upper <= -1.9 ~ TRUE,
    baseline_glyc == '10' & upper <= -2 ~ TRUE
  )) %>%
  filter(check == TRUE) %>%
  group_by(trt_new, baseline_glyc) %>%
  filter(pred == max(pred) & trt_new != "Stretching") %>%
    mutate_if(is.numeric, round, 3))



# optimal doses
optimal_list <- list(Prediabetes = tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>%
  filter(baseline == "Prediabetes") %>%
  group_by(trt_new, baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(trt_new, baseline_glyc) %>%
  filter(pred == min(pred)) %>%
  mutate_if(is.numeric, round, 3),
  Controlled = tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>%
  filter(baseline == "Controlled T2DM") %>%
  group_by(trt_new, baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(trt_new, baseline_glyc) %>%
  filter(pred == min(pred)) %>%
  mutate_if(is.numeric, round, 3),
  Uncontrolled = tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>%
  filter(baseline == "Uncontrolled T2DM") %>%
  group_by(trt_new, baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(trt_new, baseline_glyc) %>%
  filter(pred == min(pred)) %>%
  mutate_if(is.numeric, round, 3),
  Severe = tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>%
  filter(baseline == "Severe uncontrolled T2DM") %>%
  group_by(trt_new, baseline_glyc, weekly_dose) %>%
  summarise(pred = mean(.epred),
            se = sd(.epred),
            lower = pred - qnorm(0.975)*se,
            upper = pred + qnorm(0.975)*se) %>%
  ungroup() %>%
  group_by(trt_new, baseline_glyc) %>%
  filter(pred == min(pred)) %>%
  mutate_if(is.numeric, round, 3))
```


We can describe a similar pattern between the different interventions: doses between **800 and 1200 METs-min/week** showed a greater HbA1c reduction than higher doses. Also, some interventions are likely to be more effective than others. For instance, HIIT or multicomponent interventions showed darker zones than cycling or strength interventions. That could be better observe when baseline glycemia levels are controlled (< 8%). Predicted mean responses that achieved a *clinically* meaningful effect are presented below. 

```{r, echo=FALSE}
# Table with dose points that achieved a clinically meaningful response (i.e., -0.5)
tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>% # excluding usual care because of the dose and stretching due to evidence-based decision
  filter(weekly_dose != 0) %>%
  filter(round(.epred, 4) == -0.5) %>% 
  select(weekly_dose, baseline_glyc, trt_new, .epred) %>%
  rename(Dose = weekly_dose,
         `Baseline level` = baseline_glyc,
         `Intervention` = trt_new,
         `Predicted response` = .epred) %>% 
  group_by(`Baseline level`, `Intervention`, Dose) %>%
  summarise(`Predicted change` = mean(`Predicted response`)) %>%
  arrange(`Baseline level`, Dose) %>%
  ungroup() %>%
  as.data.frame() 
```


### Posterior predictions: dose-response relationships by intervention

Here we are going to categorize the baseline levels as in previous analyses (i.e., by ADA cut-points and specific baseline points).


#### Categorizing by ADA cut-points

```{r, fig.height=10, fig.width=12, echo=FALSE}
tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>% # excluding usual care because of the dose and stretching due to evidence-based decision
  mutate(baseline = case_when(
    baseline_glyc < 6.5 ~ "Prediabetes",
    baseline_glyc >= 6.5 & baseline_glyc <= 7 ~ "Controlled T2DM",
    baseline_glyc > 7 & baseline_glyc <= 8 ~ "Uncontrolled T2DM",
    baseline_glyc > 8 ~ "Severe uncontrolled T2DM"
  )) %>%
  mutate(baseline = factor(baseline, levels = c("Prediabetes",
                                                "Controlled T2DM",
                                                "Uncontrolled T2DM",
                                                "Severe uncontrolled T2DM"))) %>%
  ggplot(aes(x = weekly_dose, y = .epred)) +
  facet_grid(trt_new ~ baseline, scales = "free") +
  stat_lineribbon() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = -0.5, col = "red", alpha = 0.6, linetype = 2) +
  scale_fill_brewer(palette = "Greys") +
  labs(x = "Dose (METs-min/week)",
       y = "Predicted change in HbA1c (%)",
       fill = "Credible interval") +
  scale_x_continuous(breaks = seq(0, 1800, 300)) +
  scale_y_continuous(breaks = seq(-3, 1, 0.5)) +
  theme_bw() +
  theme(legend.position = "bottom")
```


All interventions shared similar dose-response patterns. Some interventions presented a greater effect above the rest, like multicomponent or strength interventions. To determine the most efficient intervention, we present below the cut-points grouped by baseline level, intervention and doses that achieved a *clinically* significant effect (i.e., their credible intervals did not include the 0).

```{r, echo=FALSE}
# Cutoffs 
tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>%
  mutate(baseline = case_when(
    baseline_glyc < 6.5 ~ "Prediabetes",
    baseline_glyc >= 6.5 & baseline_glyc <= 7 ~ "Controlled T2DM",
    baseline_glyc > 7 & baseline_glyc <= 8 ~ "Uncontrolled T2DM",
    baseline_glyc > 8 ~ "Severe uncontrolled T2DM"
  )) %>%
  mutate(baseline = factor(baseline, levels = c("Prediabetes",
                                                "Controlled T2DM",
                                                "Uncontrolled T2DM",
                                                "Severe uncontrolled T2DM"))) %>%
  group_by(baseline, trt_new, weekly_dose) %>%
  summarise(mean = mean(.epred),
            sd = sd(.epred),
            lower = mean - qnorm(0.975)*sd,
            upper = mean + qnorm(0.975)*sd) %>%
  filter(upper <= -0.4999) %>% 
  mutate_if(is.numeric, round, 3) %>%
  as.data.frame()
```


#### Categorizing by specific baseline points

We presented below the cut-points grouped by baseline level, intervention and doses that achieved a *clinically* significant effect (i.e., their credible intervals did not include the 0).

```{r, echo=FALSE, eval=FALSE, echo=FALSE}
# Cutoffs 
tidy_epred.int %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>%
  filter(baseline_glyc %in% seq(6, 10, 1)) %>%
  mutate(baseline_glyc = paste("Baseline =", baseline_glyc,"%"),
         baseline_glyc = factor(baseline_glyc, levels = c("Baseline = 6 %", "Baseline = 7 %", 
                                                          "Baseline = 8 %", "Baseline = 9 %",
                                                          "Baseline = 10 %"))) %>%
  group_by(baseline_glyc, trt_new, weekly_dose) %>%
  summarise(mean = mean(.epred),
            sd = sd(.epred),
            lower = mean - qnorm(0.975)*sd,
            upper = mean + qnorm(0.975)*sd) %>%
  filter(upper <= -0.4999) %>% 
  mutate_if(is.numeric, round, 3) %>%
  arrange(baseline_glyc) %>%
  as.data.frame()
```


#### How long does it take to a person with controlled T2DM to achieve a clinical target of <6.5% (prediabetes)?

```{r, echo=FALSE, fig.height=10, fig.width=12, eval=FALSE, echo=FALSE}
# fitting the model
model.heat <- brm(y | se(se) ~ 1 + s(baseline_glyc, k = 4) + s(weekly_dose, k = 4) + s(duration_weeks, k = 4) + (1 | studyID + trt_new),
             data = data %>%
                    filter(studyID != "Brun, 2008"), 
             control = list(adapt_delta = 0.99))

## prediction model
tidy_model <- model.heat %>%
  epred_draws(newdata = expand_grid(weekly_dose = seq(0, 1800, 30), # 30-METs-min increases
                                    baseline_glyc = seq(8, 10, 0.5),
                                    se = mean(data$se), 
                                    duration_weeks = c(6, 12, 18, 24, 36), # data points where data is concentrated
                                    trt_new = data$trt_new %>% unique()),  
              re_formula = ~ (1 + trt_new))

tidy_model %>%
  filter(trt_new != "Usual care" & trt_new != "Stretching") %>% # excluding usual care because of the dose and stretching due to evidence-based decision %>%
  mutate(baseline_glyc = paste("Baseline =", baseline_glyc,"%"),
         baseline_glyc = factor(baseline_glyc, levels = c("Baseline = 6.5 %", "Baseline = 6.6 %", 
                                                          "Baseline = 6.7 %", "Baseline = 6.8 %",
                                                          "Baseline = 6.9 %", "Baseline = 7 %"))) %>%
  ggplot(aes(x = weekly_dose, y = .epred)) +
 # facet_grid(trt_new ~ baseline_glyc, scales = "free") +
  stat_lineribbon() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = -0.5, col = "red", alpha = 0.6, linetype = 2) +
  facet_wrap(~ trt_new) +
  scale_fill_brewer(palette = "Greys") +
  labs(x = "Dose (METs-min/week)",
       y = "Predicted change in HbA1c (%)",
       fill = "Credible interval") +
  scale_x_continuous(breaks = seq(0, 1800, 300)) +
  scale_y_continuous(breaks = seq(-3, 1, 0.5)) +
  theme_bw() +
  theme(legend.position = "bottom")


# COMBINED MATRIX
## doses that achieved the maximal reduction in HbA1c
pre.model <- tidy_model %>% 
  mutate(baseline_glyc = factor(baseline_glyc)) %>% 
  group_by(baseline_glyc, duration_weeks, trt_new) %>% 
  summarise(check = ifelse(.epred == min(.epred), weekly_dose, FALSE)) %>%
  filter(check != FALSE) %>%
  mutate(duration_weeks = factor(duration_weeks)) %>%
  rename(weekly_dose = check)

## create a data frame with the minimal effective dose points that achieve the clinical target for prediabetes
points_model <- tidy_model %>% 
  mutate(baseline_glyc = factor(baseline_glyc)) %>% 
  group_by(baseline_glyc, duration_weeks, weekly_dose, trt_new) %>% 
  summarise(mean = mean(.epred),
            sd = sd(.epred),
            lower = mean - qnorm(0.975)*sd,
            upper = mean + qnorm(0.975)*sd) %>%
  ungroup() %>%
  mutate(target = case_when(
    baseline_glyc == 8 & upper < -0.1 ~ TRUE,
    baseline_glyc == 8.5 & upper <= -0.5 ~ TRUE,
    baseline_glyc == 9 & upper <= -1 ~ TRUE,
    baseline_glyc == 9.5 & upper <= -1.5 ~ TRUE,
    baseline_glyc == 10 & upper <= -2 ~ TRUE
  )) %>%
  filter(target == TRUE) %>%
  mutate(duration_weeks = factor(duration_weeks)) %>%
  group_by(baseline_glyc, duration_weeks, trt_new) %>%
  summarise(weekly_dose = min(weekly_dose)) %>%
  mutate(comb = paste(baseline_glyc, duration_weeks, trt_new),
         check = 0)

# heat map plot with clinically significant dose values and (non-clinically significant) optimal doses
pre.model %>%
  mutate(duration_weeks = as.character(duration_weeks),
         comb = paste(baseline_glyc, duration_weeks, trt_new),
         check = ifelse(comb %in% points_model$comb, 0, 1)) %>%
  filter(check == 1) %>%
  full_join(., points_model) %>% arrange(baseline_glyc) %>%
  ungroup() %>%
  mutate(label = ifelse(check != 1, paste(weekly_dose,"*", sep = ""), weekly_dose)) %>%
  mutate(duration_weeks = factor(duration_weeks,
                                 levels = c(6, 12, 18, 24, 36))) %>%
  ggplot(aes(x = duration_weeks, y = baseline_glyc)) +
  geom_tile(aes(fill = weekly_dose), col = "white") +
  geom_text(aes(label = label)) +
  scale_fill_gradientn(colours = colorspace::heat_hcl(7)) +
  facet_wrap(~ trt_new) +
  labs(x = "Intervention duration (weeks)",
       y = "Baseline glycemic level (%)",
       fill = "Dose\n(METs-min/week)",
       title = "Minimal effective and optimal doses to achieve clinical target of prediabetes") +
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        legend.key.width = grid::unit(1.5, "cm"),
        legend.spacing.x = grid::unit(1.2, "cm"),
        legend.box.spacing = grid::unit(1, "cm"))
```

Finished. If any question has arisen throughout the code, please, do not hesitate to contact EPAFit Research Group by the mail: dggomez@us.es

```{r}
sessionInfo()
```

